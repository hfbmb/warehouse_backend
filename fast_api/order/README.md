# Order Module Documentation

## Overview

The `order` module is responsible for handling all operations related to orders, including rentals and sales. It's built using FastAPI and integrates with MongoDB for data storage.

## File Structure

- `constants.py`: Contains all the constant values and enums used across the `order` module.
- `exception.py`: Defines custom exceptions that are specific to the `order` module.
- `models.py`: Contains the data models for orders, which define the structure of the data.
- `README.md`: This file, which provides documentation for the `order` module.
- `router.py`: Defines the API routes for general order operations.
- `service.py`: Contains the business logic for handling orders, such as database interactions.
- `email_sender.py`: Responsible for sending emails related to order operations.
- `__init__.py`: An empty file that indicates that this directory should be considered a Python package.
- `__pycache__`: A folder generated by Python that contains byte-compiled files.
- `rental_warehouse_router.py`: Defines the API routes for rental operations related to warehouses.
- `salesman_router.py`: Defines the API routes for operations related to salesmen.

This brief documentation should provide a good starting point for understanding the `order` module. Feel free to reach out if you have any questions!


# Order Management API Documentation

## Overview

This API focuses on order-related operations, such as creating, updating, and fetching orders. It's built using FastAPI and integrates with MongoDB for data storage.

## API Endpoints

### Fetch Team Members of an Order

- **URL**: `/orders/{order_id}/team`
- **Method**: `GET`
- **Description**: Fetches the team members associated with a specific order.
- **Parameters**: 
  - `order_id` (str): The ID of the order.

#### Code Explanation

- `user_has_permission`: Checks if the current user has the appropriate permissions to access this endpoint.
- `users_by_order_id`: Fetches the team members by the order ID.

### Start Work on an Order

- **URL**: `/orders/{order_id}/start`
- **Method**: `GET`
- **Description**: Initiates work on a specific order.
- **Parameters**: 
  - `order_id` (str): The ID of the order.

#### Code Explanation

- `start_user_work`: Starts work on the specified order.
- `manager.send_message`: Sends a WebSocket message to inform the user.

### Fetch All Orders

- **URL**: `/orders/`
- **Method**: `GET`
- **Description**: Fetches all orders.
- **Parameters**: None

#### Code Explanation

- `user_has_permission`: Checks if the current user has the appropriate permissions to access this endpoint.
- `service.return_all_orders`: Fetches all orders based on the user's role and access.

### Fetch Order Details

- **URL**: `/orders/{order_id}/info`
- **Method**: `GET`
- **Description**: Fetches detailed information about a specific order.
- **Parameters**: 
  - `order_id` (str): The ID of the order.

#### Code Explanation

- `service.get_order_by_id`: Fetches the order details by its ID.

### Create a New Order

- **URL**: `/orders/`
- **Method**: `POST`
- **Description**: Creates a new order.
- **Parameters**: 
  - `order` (Order): The details of the new order.
  - `company` (str, optional): The name of the company associated with the order.
  - `token` (str, optional): A token for validating the order creation.

#### Code Explanation

- `check_order_creation_token`: Validates the token for order creation.
- `service.register_order`: Registers the new order in the database.

---

### Update an Existing Order

- **URL**: `/orders/{order_id}`
- **Method**: `PUT`
- **Description**: Updates an existing order.
- **Parameters**: 
  - `updated_fields` (Order): The fields to update in the order.
  - `order_id` (str): The ID of the order to update.
  - `token` (str, optional): A token for validating the order update.

#### Code Explanation

- `check_order_creation_token`: Validates the token for order update.
- `service.update_order`: Updates the order in the database based on the provided fields.

### Delete an Order by ID

- **URL**: `/orders/{order_id}`
- **Method**: `DELETE`
- **Description**: Deletes an order by its ID.
- **Parameters**: 
  - `order_id` (str): The ID of the order to delete.

#### Code Explanation

- `user_has_permission`: Checks if the current user has the appropriate permissions to access this endpoint.
- `service.delete_order_by_order_id`: Deletes the order by its ID from the database.

### Create an Invoice for an Order

- **URL**: `/orders/{order_id}/invoice`
- **Method**: `PUT`
- **Description**: Creates an invoice for a specific order.
- **Parameters**: 
  - `order_id` (str): The ID of the order for which to create an invoice.
  - `workers` (ManagerSideProduct): The details of the workers involved in the order.

#### Code Explanation

- `user_has_permission`: Checks if the current user has the appropriate permissions to access this endpoint.
- `service.update_order_invoice`: Updates the order with invoice details.

### Approve or Reject Order Products

- **URL**: `/orders/{order_id}/approve`
- **Method**: `PUT`
- **Description**: Approves or rejects the products in an order.
- **Parameters**: 
  - `order_id` (str): The ID of the order.
  - `approve` (bool): Whether to approve or reject the products.

#### Code Explanation

- `user_has_permission`: Checks if the current user has the appropriate permissions to access this endpoint.
- `service.update_order_status`: Updates the status of the order based on the approval decision.

---

## Additional Notes

- The `user_has_permission` function is used to check if the current user has the required permissions to perform certain actions. This is based on their role and the company they belong to.
- The `service` module contains the core logic for interacting with the database.




# Salesman API Documentation

## Overview

This API is designed to manage various operations related to salesmen, such as generating unique URLs, updating orders, and allocating products to boxes. It's built using FastAPI and integrates with MongoDB for data storage.

## API Endpoints

### Generate Unique URL for Salesman

- **URL**: `/salesman/generate_url/`
- **Method**: `GET`
- **Description**: Generates a unique URL for a salesman.
- **Parameters**: None

#### Code Explanation

- `get_current_user`: A dependency that retrieves the current user's information. This is automatically fetched from the user's session or token.
- `generate_unique_url`: A function that generates a unique URL token.
- `service.create_token`: A function that stores the token in the database.

### Generate URL for Updating an Existing Order

- **URL**: `/salesman/{order_id}/generate_url_update`
- **Method**: `GET`
- **Description**: Generates a URL for updating an existing order.
- **Parameters**: 
  - `order_id`: The ID of the order to update. This can be obtained from the database or from the client who created the order.

#### Code Explanation

- `service.get_order_by_id`: Retrieves the existing order by its ID.
- `service.create_token`: Stores the token in the database.

### Get All Sub-Orders by Main Order ID

- **URL**: `/salesman/{order_id}`
- **Method**: `GET`
- **Description**: Retrieves all sub-orders related to a main order.
- **Parameters**: 
  - `order_id`: The ID of the main order. This can be obtained from the database or from the client who created the main order.

#### Code Explanation

- `service.get_all_sub_orders`: Retrieves all sub-orders based on the main order ID.

### Create Sub-Order

- **URL**: `/salesman/`
- **Method**: `POST`
- **Description**: Creates a new sub-order.
- **Parameters**: 
  - `orders`: The sub-orders to create. This should be a JSON object containing the details of the sub-orders.

#### Code Explanation

- `service.register_order`: Registers a new sub-order in the database.
- `service.update_order`: Updates the main order to include the new sub-order IDs.

### Record Sales-Related Information for an Order

- **URL**: `/salesman/{order_id}/record`
- **Method**: `PUT`
- **Description**: Records sales-related information for an existing order.
- **Parameters**: 
  - `order_id`: The ID of the order to update. This can be obtained from the database or from the client who created the order.
  - `salesman_order`: The sales-related information to record. This should be a JSON object containing the sales-related details.

#### Code Explanation

- `service.get_order_by_id`: Retrieves the existing order by its ID.
- `service.update_order_invoice`: Updates the order with the new sales-related information.

### Allocate Products to Boxes

- **URL**: `/salesman/{order_id}/product/allocation`
- **Method**: `PUT`
- **Description**: Allocates products to boxes.
- **Parameters**: 
  - `order_id`: The ID of the order to update. This can be obtained from the database or from the client who created the order.
  - `data`: The product and box allocation data. This should be a JSON object containing the product IDs and the box IDs.

#### Code Explanation

- `boxes_with_product`: A function that allocates products to boxes.
- `service.update_order_invoice`: Updates the order with the new box allocation.

---





# Rental API Documentation

## Overview

This API focuses on rental-related operations, such as creating rental orders and fetching rental data. It's built using FastAPI and integrates with MongoDB for data storage.

## API Endpoints

### Rent a Cell by Client

- **URL**: `/rental/cell/`
- **Method**: `POST`
- **Description**: Allows a client to rent a cell.
- **Parameters**: 
  - `data`: The data for renting a cell. This should be a JSON object containing the details of the cell to rent.

#### Code Explanation

- `check_role_access`: Checks if the current user has the appropriate role to access this endpoint.
- `service.register_order`: Registers the rental order in the database.

### Create a Rental Order

- **URL**: `/rental/`
- **Method**: `POST`
- **Description**: Creates a new rental order.
- **Parameters**: 
  - `rent_data`: The data for the rental order. This should be a JSON object containing the details of the rental.

#### Code Explanation

- `check_role_access`: Checks if the current user has the appropriate role to access this endpoint.
- `service.register_order`: Registers the rental order in the database.

### Get a Rental Order by ID

- **URL**: `/rental/{order_id}`
- **Method**: `GET`
- **Description**: Retrieves a rental order by its ID.
- **Parameters**: 
  - `order_id`: The ID of the rental order to retrieve. This can be obtained from the database or from the client who created the order.

#### Code Explanation

- `check_role_access`: Checks if the current user has the appropriate role to access this endpoint.
- `service.get_order_by_id`: Retrieves the rental order by its ID from the database.

### Get All Rental Orders

- **URL**: `/rental/`
- **Method**: `GET`
- **Description**: Retrieves all rental orders.
- **Parameters**: None

#### Code Explanation

- `check_role_access`: Checks if the current user has the appropriate role to access this endpoint.
- `service.return_all_orders`: Retrieves all rental orders associated with the current user from the database.

---
